<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>Lesson 6: Advanced validation - OpenXava</title>
    <link rel="stylesheet" href="static/style.css" type="text/css">
    <link rel="stylesheet" href="highlight/highlight.css">
    <script src="highlight/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body>
    <div class="wiki" id="content_view" style="display: block;">
      <h1 id="toc0"><a name="Lesson 6: Advanced validation"></a> <span id="breadcrumbs">
          <span id="openxava"> <a href="https://www.openxava.org/"> <span>o</span>pen<span>x</span>ava
              </a> </span> / <a href="index_en.html">documentation</a> / </span>
        Lesson 6: Advanced validation </h1>
      <strong>Course</strong>: <a class="wiki_link" href="getting-started_en.html">1.
        Getting started</a> | <a class="wiki_link" href="modeling_en.html">2.
        Modeling with Java</a> | <a class="wiki_link" href="testing_en.html">3.
        Automated testing</a> | <a class="wiki_link" href="inheritance_en.html">4.
        Inheritance</a> | <a class="wiki_link" href="basic-business-logic_en.html">5.
        Basic business logic</a> | <strong>6. Advanced validation</strong> | <a

        class="wiki_link" href="refining-standard-behavior_en.html">7. Refining
        the standard behavior</a> | <a class="wiki_link" href="business-logic-behavior_en.html">8.
        Behavior &amp; business logic</a> | <a class="wiki_link" href="references-collections_en.html">9.
        References &amp; collections</a> | <a class="wiki_link" href="philosophy_en.html">A.
        Architecture &amp; philosophy</a> | <a class="wiki_link" href="jpa_en.html">B.
        Java Persistence API</a> | <a class="wiki_link" href="annotations_en.html">C.
        Annotations</a>
      <hr>
      <div id="toc">
        <h1 class="nopad">Table of contents</h1>
        <div style="margin-left: 1em;"><a href="#Lesson%206:%20Advanced%20validation">Lesson
            6: Advanced validation</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%206:%20Advanced%20validation-Validation%20alternatives">Validation
            alternatives</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Validation%20alternatives-Adding%20delivered//%20property%20to%20//Order">Adding
            delivered// property to //Order</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Validation%20alternatives-Validating%20with%20@EntityValidator">Validating
            with @EntityValidator</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Validation%20alternatives-Validating%20with%20a%20JPA%20callback%20method">Validating
            with a JPA callback method</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Validation%20alternatives-Validating%20in%20the%20setter">Validating
            in the setter</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Validation%20alternatives-Validating%20with%20Bean%20Validation">Validating
            with Bean Validation</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Validation%20alternatives-Validating%20on%20removal%20with%20@RemoveValidator">Validating
            on removal with @RemoveValidator</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Validation%20alternatives-Validating%20on%20removal%20with%20a%20JPA%20callback%20method">Validating
            on removal with a JPA callback method</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Validation%20alternatives-What%27s%20the%20best%20way%20of%20validating?">What's
            the best way of validating?</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%206:%20Advanced%20validation-Creating%20your%20own%20Bean%20Validation%20annotation">Creating
            your own Bean Validation annotation</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Creating%20your%20own%20Bean%20Validation%20annotation-Using%20a%20Bean%20Validation%20from%20your%20entity">Using
            a Bean Validation from your entity</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Creating%20your%20own%20Bean%20Validation%20annotation-Defining%20your%20own%20ISBN%20annotation">Defining
            your own ISBN annotation</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Creating%20your%20own%20Bean%20Validation%20annotation-Using%20Apache%20Commons%20Validator%20to%20implement%20the%20validation%20logic">Using
            Apache Commons Validator to implement the validation logic</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Creating%20your%20own%20Bean%20Validation%20annotation-Call%20to%20a%20REST%20web%20service%20to%20validate%20the%20ISBN">Call
            to a REST web service to validate the ISBN</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-Creating%20your%20own%20Bean%20Validation%20annotation-Adding%20attributes%20to%20your%20annotation">Adding
            attributes to your annotation</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%206:%20Advanced%20validation-JUnit%20tests">JUnit
            tests</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-JUnit%20tests-Testing%20validation%20for%20adding%20to%20a%20collection">Testing
            validation for adding to a collection</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-JUnit%20tests-Testing%20validation%20assigning%20a%20reference%20and%20validation%20on%20removal">Testing
            validation assigning a reference and validation on removal</a></div>
        <div style="margin-left: 3em;"><a href="#Lesson%206:%20Advanced%20validation-JUnit%20tests-Testing%20the%20custom%20Bean%20Validation">Testing
            the custom Bean Validation</a></div>
        <div style="margin-left: 2em;"><a href="#Lesson%206:%20Advanced%20validation-Summary">Summary</a></div>
      </div>
      So far we have only done some basic validations using the <span class="wiki jcode">@Required</span>
      annotation. Sometimes it's convenient to write our own logic for the
      validation.<br>
      In <a class="wiki_link" href="annotations_en#toc1">appendix C</a> we
      introduce the <span class="wiki jcode">@Required</span> annotation as a
      basic way to implement validation logic. In this lesson we are going to
      describe custom validation methods which allow us to add specific business
      logic to your application.<br>
      <h2 id="toc1"><a name="Lesson 6: Advanced validation-Validation alternatives"></a>Validation
        alternatives</h2>
      We are going to enhance your code with this logic: if the orders are not
      delivered yet, then the user cannot assign them to an invoice. That is,
      only delivered orders can be associated with an invoice.<br>
      <h3 id="toc2"><a name="Lesson 6: Advanced validation-Validation alternatives-Adding delivered// property to //Order"></a>Adding
        <em>delivered</em> property to <em>Order</em></h3>
      First you have to add a new property to the <em>Order</em> entity. The <em>delivered</em>
      property:<br>
      <pre><code class="java">private boolean delivered;
 
public boolean isDelivered() {
    return delivered;
}
 
public void setDelivered(boolean delivered) {
    this.delivered = delivered;
}
</code></pre> Moreover it's necessary to add the <em>delivered</em> property to
      the view. Modify the <em>Order</em> view as shown in the following code:<br>
      <pre><code class="java">@View( extendsView="super.DEFAULT",
     members="delivered; invoice { invoice }"
)
...
public class Order extends CommercialDocument {
</code></pre> There is a new <em>delivered</em> property now which indicates
      the delivery state of an order. Try the new code and mark some of the
      existing orders as delivered.<br>
      <table class="wiki_table">
        <tbody>
          <tr>
            <td><strong>Note:</strong><br>
              When the application is started, the <em>delivered</em> column
              will be added to the <em>CommercialDocument</em> table, it will
              have the value <em>null</em> for all records. We need to update
              this column with the following SQL statement:<br>
              <style type="text/css"><!--
/**
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 */
.mysql  {font-family:monospace;}
.mysql .imp {font-weight: bold; color: red;}
.mysql .kw1 {color: #990099; font-weight: bold;}
.mysql .kw2 {color: #990099; font-weight: bold;}
.mysql .kw3 {color: #9900FF; font-weight: bold;}
.mysql .kw4 {color: #999900; font-weight: bold;}
.mysql .kw5 {color: #999900; font-weight: bold;}
.mysql .kw6 {color: #FF9900; font-weight: bold;}
.mysql .kw7 {color: #FF9900; font-weight: bold;}
.mysql .kw8 {color: #9900FF; font-weight: bold;}
.mysql .kw9 {color: #9900FF; font-weight: bold;}
.mysql .kw10 {color: #CC0099; font-weight: bold;}
.mysql .kw11 {color: #CC0099; font-weight: bold;}
.mysql .kw12 {color: #009900;}
.mysql .kw13 {color: #000099;}
.mysql .kw14 {color: #000099;}
.mysql .kw15 {color: #000099;}
.mysql .kw16 {color: #000099;}
.mysql .kw17 {color: #000099;}
.mysql .kw18 {color: #000099;}
.mysql .kw19 {color: #000099;}
.mysql .kw20 {color: #000099;}
.mysql .kw21 {color: #000099;}
.mysql .kw22 {color: #000099;}
.mysql .kw23 {color: #000099;}
.mysql .kw24 {color: #000099;}
.mysql .kw25 {color: #000099;}
.mysql .kw26 {color: #000099;}
.mysql .kw27 {color: #00CC00;}
.mysql .coMULTI {color: #808000; font-style: italic;}
.mysql .co1 {color: #808080; font-style: italic;}
.mysql .co2 {color: #808080; font-style: italic;}
.mysql .es0 {color: #004000; font-weight: bold;}
.mysql .es1 {color: #008080; font-weight: bold;}
.mysql .br0 {color: #FF00FF;}
.mysql .sy1 {color: #CC0099;}
.mysql .sy2 {color: #000033;}
.mysql .st0 {color: #008000;}
.mysql .nu0 {color: #008080;}
.mysql span.xtra { display:block; }

-->
</style><pre class="mysql"><span class="kw1">UPDATE</span> CommercialDocument
<span class="kw1">SET</span> delivered <span class="sy1">=</span> <span class="kw3">false</span></pre>
            </td>
          </tr>
        </tbody>
      </table>
      <h3 id="toc3"><a name="Lesson 6: Advanced validation-Validation alternatives-Validating with @EntityValidator"></a>Validating
        with <em>@EntityValidator</em></h3>
      Up to now the user can add any order to any invoice from the <em>Invoice</em>
      module, and he can associate a particular invoice with any order from the
      <em>Order</em> module. We are going to restrict this: only delivered
      orders are allowed to be added to an invoice.<br>
      The first alternative to implement this validation is by using an <span class="wiki jcode">@EntityValidator</span>.
      This annotation allows you to assign the desired validation logic to your
      entity. Let's annotate the <em>Order</em> entity as show in following
      code:<br>
      <pre><code class="java">@EntityValidator(
    value=DeliveredToBeInInvoiceValidator.class, // The class with the validation logic
    properties= {
        @PropertyValue(name="year"), // The content of these properties
        @PropertyValue(name="number"), // is moved from the 'Order' entity
        @PropertyValue(name="invoice"), // to the validator before
        @PropertyValue(name="delivered") // executing the validation
    }
)
public class Order extends CommercialDocument {
</code></pre> Every time an <em>Order</em> object is created or modified an
      object of type <em>DeliveredToBeInInvoiceValidator</em> is created. Then
      its properties <em>year</em>, <em>number</em>, <em>invoice</em> and <em>delivered</em>
      are initialized with the properties of the same name from the <em>Order</em>
      object. After that, the <span class="wiki jcode">validate()</span> method
      of the validator is executed. You can see the code for the validator:<br>
      <pre><code class="java">package com.yourcompany.invoicing.validators; // In 'validators' package

import com.yourcompany.invoicing.model.*;
import org.openxava.util.*;
import org.openxava.validators.*;
 
public class DeliveredToBeInInvoiceValidator
    implements IValidator { // Must implement IValidator
 
    private int year; // Properties to be injected from Order
    private int number;
    private boolean delivered;
    private Invoice invoice;
 
    public void validate(Messages errors) // The validation logic
        throws Exception
    {
        if (invoice == null) return;
        if (!delivered) {
            errors.add( // By adding messages to errors the validation will fail
                "order_must_be_delivered", // An id from i18n file
                year, number); // Arguments for the message
         }
    }
    // Getters and setters for year, number, delivered and invoice
    ...
}
</code></pre> The validation logic is absolutely straightforward: if an invoice
      is present and this order is not marked as delivered we add an error
      message, so the validation will fail. You should add the error message in
      the <em>Invoicing/i18n/Invoicing-messages_en.properties</em> file. As
      shown below:<br>
      <pre><code class="properties"># Messages for the Invoicing application
order_must_be_delivered=Order {0}/{1} must be delivered in order to be added to an Invoice
</code></pre> Now you can try to add orders to an invoice with the application,
      you will see how the undelivered orders are rejected, as shown the next
      figure:<br>
      <img src="files/validation_en010.png" alt="validation_en010.png" title="validation_en010.png"><br>
      Your validation is implemented correctly with <span class="wiki jcode">@EntityValidator</span>.
      It's not difficult, but a little “verbose”, because you need to write a
      “fully featured” new class merely to add 2 lines of code logic. Let's
      learn other ways to do the same validation.<br>
      <h3 id="toc4"><a name="Lesson 6: Advanced validation-Validation alternatives-Validating with a JPA callback method"></a>Validating
        with a JPA callback method</h3>
      We're going to try another, maybe even simpler, way to do this validation,
      we'll transfer the validation logic from the validator class into the <em>Order</em>
      entity itself, in this case in a <span class="wiki jcode">@PreUpdate</span>
      method.<br>
      First, remove the <em>DeliveredToBeInInvoiceValidator</em> class from
      your project. Then remove the <span class="wiki jcode">@EntityValidator</span>
      annotation from your <em>Order</em> entity:<br>
      <pre><code class="java">//@EntityValidator( // Remove the '@EntityValidator' annotation
//    value=DeliveredToBeInInvoiceValidator.class,
//    properties= {
//        @PropertyValue(name="year"),
//        @PropertyValue(name="number"),
//        @PropertyValue(name="invoice"),
//        @PropertyValue(name="delivered")
//    }
//)
public class Order extends CommercialDocument {
</code></pre> After that we're going to add the validation again, but now inside
      the <em>Order</em> class itself. Add the <em>validate()</em> method to
      your <em>Order</em> class:<br>
      <pre><code class="java">@PreUpdate // Just before updating the database
private void validate()  throws Exception {
    if (invoice != null &amp;&amp; !isDelivered()) { // The validation logic
        // The validation exception from Bean Validation
        throw new javax.validation.ValidationException(
            XavaResources.getString(
                "order_must_be_delivered",
                getYear(),
                getNumber()
            )
        );
    }
}
</code></pre> Before saving an order this validation will be executed, if it
      fails an <span class="wiki jcode">ValidationException</span> is thrown.
      This exception is from the <em>Bean Validation</em> framework, so
      OpenXava knows that it is a validation exception. This way with only one
      method within your entity you have the validation done.<br>
      <h3 id="toc5"><a name="Lesson 6: Advanced validation-Validation alternatives-Validating in the setter"></a>Validating
        in the setter</h3>
      Another alternative to do your validation is to put the validation logic
      inside the setter method. That's a simple approach. First, remove the <em>validate()</em>
      method from the <em>Order</em> entity, and modify the <em>setInvoice()</em>
      method in the way you see below:<br>
      <pre><code class="java">public void setInvoice(Invoice invoice) {
    if (invoice != null &amp;&amp; !isDelivered()) { // The validation logic
        // The validation exception from Bean Validation
        throw new javax.validation.ValidationException(
            XavaResources.getString(
                "order_must_be_delivered",
                getYear(),
                getNumber()
            )
        );
    }
    this.invoice = invoice; // The regular setter assignment
}
</code></pre> This works exactly the same way as the two other options. This is
      like the <span class="wiki jcode">@PreUpdate</span> alternative, only
      that it does not depend on JPA, it's a basic Java implementation.<br>
      <h3 id="toc6"><a name="Lesson 6: Advanced validation-Validation alternatives-Validating with Bean Validation"></a>Validating
        with <em>Bean Validation</em></h3>
      As a last option we are going to do the shortest one: The validation logic
      is put into a boolean method annotated with the <span class="wiki jcode">@AssertTrue</span>
      Bean Validation annotation.<br>
      To implement this alternative first remove the validation logic from the <em>setInvoice()</em>
      method. Then add the <em>isDeliveredToBeInInvoice()</em> method to your <em>Order</em>
      entity:<br>
      <pre><code class="java">@AssertTrue( // Before saving it asserts if this method returns true, if not it throws an exception
    message="order_must_be_delivered" // Error message in case false
)
private boolean isDeliveredToBeInInvoice() {
    return invoice == null || isDelivered(); // The validation logic
}
</code></pre> In previous forms of validation our error message was constructed
      using two arguments, <em>year</em> and <em>number</em>, which in our
      i18n file are represented by <em>{0}/{1}</em> respectively. For the
      validation case with <span class="wiki jcode">@AssertTrue</span> we can
      not pass these two arguments to construct our error message, but we can
      declare properties and qualified properties of the validated bean in the
      definition of the message. Let's see how to modify the definition of the
      message:<br>
      <pre><code class="properties"># Messages for the Invoicing application
order_must_be_delivered=Order {year}/{number} must be delivered in order to be added to an Invoice
</code></pre> OpenXava will fill <em>{year}/{number}</em> with values of <em>year</em>
      and <em>number</em> that has the <em>Order</em> being updated and does
      not fulfill the condition of validation.<br>
      This is the simplest way to validate, because the method with the
      validation only has to be annotated. The Bean Validation is responsible
      for calling this method when saving takes place, and throws the
      corresponding <span class="wiki jcode">ValidationException</span> if the
      validation does not succeed.<br>
      <h3 id="toc7"><a name="Lesson 6: Advanced validation-Validation alternatives-Validating on removal with @RemoveValidator"></a>Validating
        on removal with <em>@RemoveValidator</em></h3>
      The validations we have seen until now are processed when the entity is
      modified, but sometimes it's useful or it's required to process the
      validation before the removal of the entity, and to use the validation to
      cancel the entity removal.<br>
      We are going to modify the application to reject the removal of an order
      if it has an invoice associated. To achieve this annotate your <em>Order</em>
      entity with <span class="wiki jcode">@RemoveValidator</span>, as show in
      following code:<br>
      <pre><code class="java">@RemoveValidator(OrderRemoveValidator.class) // The class with the validation
public class Order extends CommercialDocument {
</code></pre> Now, before removing an order the logic in <em>OrderRemoveValidator</em>
      is executed, and if validation fails the order is not removed. Let's look
      at the code for the validator:<br>
      <pre><code class="java">package com.yourcompany.invoicing.validators; // In 'validators' package

import com.yourcompany.invoicing.model.*;
import org.openxava.util.*;
import org.openxava.validators.*;
 
public class OrderRemoveValidator
    implements IRemoveValidator { // Must implement IRemoveValidator
 
    private Order order;
 
    public void setEntity(Object entity) // The entity to remove will be injected
        throws Exception // with this method before validating
    {
        this.order = (Order) entity;
    }
 
    public void validate(Messages errors) // The validation logic
        throws Exception
    {
        if (order.getInvoice() != null) {
            // By adding messages to errors the validation
            // will fail and the removal will be aborted
            errors.add("cannot_delete_order_with_invoice");
        }
    }
}
</code></pre> The validation logic is in the <span class="wiki jcode">validate()</span>
      method. Before calling the entity to be validated, it is injected using <span

        class="wiki jcode">setEntity()</span>. If messages are added to the
      errors object the validation will fail and the entity will not be removed.
      You have to add the error message in the <em>Invoicing/i18n/Invoicing-messages_en.properties</em>
      file:<br>
      <pre><code class="properties">cannot_delete_order_with_invoice=An order with an invoice cannot be deleted
</code></pre> If you try to remove an order with an associated invoice now, you
      will get an error message and the removal will be rejected.<br>
      You can see that using an <span class="wiki jcode">@RemoveValidator</span>
      is not difficult but verbose. You have to write a full new class to add a
      simple <span class="wiki jcode">if</span>. Let's examine a briefer
      alternative.<br>
      <h3 id="toc8"><a name="Lesson 6: Advanced validation-Validation alternatives-Validating on removal with a JPA callback method"></a>Validating
        on removal with a JPA callback method</h3>
      We're going to try another, maybe simpler, way to do this removal
      validation just by moving the validation logic from the validator class to
      the <em>Order</em> entity itself, in this case in a <span class="wiki jcode">@PreRemove</span>
      method.<br>
      First, remove the <em>OrderRemoveValidator</em> class from your project.
      Also remove the <span class="wiki jcode">@RemoveValidator</span>
      annotation from your <em>Order</em> entity:<br>
      <pre><code class="java">//@RemoveValidator(OrderRemoveValidator.class) // Remove the @RemoveValidator
public class Order extends CommercialDocument {
</code></pre> We have just removed the validation. Let's add the functionality
      again, but now inside the <em>Order</em> class itself. Add the <em>validateOnRemove()</em>
      method in your <em>Order</em> class:<br>
      <pre><code class="java">@PreRemove // Just before removing the entity
private void validateOnRemove() {
    if (invoice != null) { // The validation logic
        throw new javax.validation.ValidationException( // Throws a runtime exception
            XavaResources.getString( // To get the text message
                "cannot_delete_order_with_invoice"));
    }
}
</code></pre> This validation will be processed before the removal of an order.
      If it fails an <span class="wiki jcode">ValidationException</span> is
      thrown. You can throw any runtime exception in order to abort the removal.
      You have done the validation with a single method inside the entity.<br>
      <h3 id="toc9"><a name="Lesson 6: Advanced validation-Validation alternatives-What's the best way of validating?"></a>What's
        the best way of validating?</h3>
      You have learned several ways to do validations in your model classes.
      Which of them is the best one? All of them are valid options. It depends
      on your circumstances and personal preferences. If you have a validation
      that is non-trivial and reusable across your application, then to use <span

        class="wiki jcode">@EntityValidator</span> and <span class="wiki jcode">@RemoveValidator</span>
      is a good option. On the other hand, if you want to use your model classes
      from outside OpenXava and without JPA, then the use of validation in
      setters is better.<br>
      In our example we'll use the <span class="wiki jcode">@AssertTrue</span>
      for the “delivered to be in invoice” validation and <span class="wiki jcode">@PreRemove</span>
      for the removal validation, because this is the simplest procedure.<br>
      <br>
      <h2 id="toc10"><a name="Lesson 6: Advanced validation-Creating your own Bean Validation annotation"></a>Creating
        your own <em>Bean Validation</em> annotation</h2>
      The techniques in the previous section are very useful for many
      validations. Nevertheless, sometimes you will face some validations that
      are very generic and you will want to reuse them over and over again. In
      this case to define your own <em>Bean Validation</em> annotation can be a
      good option. Defining a <em>Bean Validation</em> is more verbose but
      usage and reuse is simple; just adding an annotation to your property or
      class.<br>
      We are going to learn how to create a validator from <em>Bean Validation</em>.<br>
      <h3 id="toc11"><a name="Lesson 6: Advanced validation-Creating your own Bean Validation annotation-Using a Bean Validation from your entity"></a>Using
        a <em>Bean Validation</em> from your entity</h3>
      It is very easy. Just annotate your property, as you see in the next code:<br>
      <pre><code class="java">@ISBN // This annotation indicates this property must be validated as an ISBN
private String isbn;
</code></pre> By merely adding <em>@ISBN</em> to your property, it will be
      validated before the entity is saved into the database. Great! The problem
      is that <em>@ISBN</em> is not included as a built-in constraint in the
      Bean Validation framework. This is not a big deal. If you want an <em>@ISBN</em>
      annotation, just create it. Indeed, we are going to create the <em>@ISBN</em>
      validation annotation in this section.<br>
      First of all, let's add a new <em>isbn</em> property to <em>Product</em>.
      Edit your <em>Product</em> class and add to it the code bellow:<br>
      <pre><code class="java">@Column(length=13)
private String isbn;
 
public String getIsbn() {
    return isbn;
}
 
public void setIsbn(String isbn) {
    this.isbn = isbn;
}
</code></pre> Try out your <em>Product</em> module with the browser. Yes, the <em>isbn</em>
      property is already there. Now, you can add the validation.<br>
      <h3 id="toc12"><a name="Lesson 6: Advanced validation-Creating your own Bean Validation annotation-Defining your own ISBN annotation"></a>Defining
        your own ISBN annotation</h3>
      Let's create the <em>@ISBN</em> annotation. First, create a package in
      your project called <em>com.yourcompany.invoicing.annotations</em>. Then
      follow the instructions in the next figure:<br>
      <img src="files/validation_en020.png" alt="validation_en020.png" title="validation_en020.png"><br>
      Edit the code of your recently created ISBN annotation and leave it as in
      the next code:<br>
      <pre><code class="java">package com.yourcompany.invoicing.annotations; // In 'annotations' package

import java.lang.annotation.*;
 
import javax.validation.*;
 
import com.yourcompany.invoicing.validators.*;
 
@Constraint(validatedBy = ISBNValidator.class)
@Target({ElementType.FIELD, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
public @interface ISBN { // A regular Java annotation definition
 
    Class&lt;?&gt;[] groups() default{};
    Class&lt;? extends Payload&gt;[] payload() default{};
    String message() default "ISBN does not exist"; // The message if validation fails
}
</code></pre> As you can see, this is a regular annotation definition. The <span

        class="wiki jcode">@Constraint</span> indicates the class with the
      validation logic. Let's write the <em>ISBNValidator</em> class.<br>
      <h3 id="toc13"><a name="Lesson 6: Advanced validation-Creating your own Bean Validation annotation-Using Apache Commons Validator to implement the validation logic"></a>Using
        Apache Commons Validator to implement the validation logic</h3>
      We are going to write the <em>ISBNValidator</em> class with the
      validation logic for an ISBN. Instead of writing the ISBN validation logic
      we'll use the <a class="wiki_link_ext" href="http://commons.apache.org/validator/"

        rel="nofollow">Commons Validator</a> project from Apache. Commons
      Validator contains validation algorithms for email addresses, dates, URLs
      and so on. The <em>commons-validator.jar</em> is included by default in
      OpenXava projects, so you can use it without further configuration. The
      code for <em>ISBNValidator</em>:<br>
      <pre><code class="java">package com.yourcompany.invoicing.validators; // In 'validators' package

import javax.validation.*;
 
import com.yourcompany.invoicing.annotations.*;
import org.openxava.util.*;
 
public class ISBNValidator
    implements ConstraintValidator&lt;ISBN, Object&gt; { // Must implement ConstraintValidator
 
    private static org.apache.commons.validator.routines.ISBNValidator
        validator = // From 'Commons Validator' framework
            new org.apache.commons.validator.routines.ISBNValidator();
 
    @Override
    public void initialize(ISBN isbn) {
 
    }
 
    @Override
    public boolean isValid(Object value,
        ConstraintValidatorContext context) { // // Contains the validation logic
        if (Is.empty(value)) return true;
        return validator.isValid(value.toString()); // Relies on 'Commons Validator'
    }
}
</code></pre> As you see, the validator class must implement <span class="wiki jcode">ConstraintValidator</span>
      from the <em>javax.validation</em> package. This forces your validator to
      implement <span class="wiki jcode">initialize()</span> and <span class="wiki jcode">isValid()</span>.
      The <span class="wiki jcode">isValid()</span> method contains the
      validation logic. Note that if the value to validate is empty we assume
      that it is valid. Validating when the value is present is the
      responsibility of other annotations like <span class="wiki jcode">@Required</span>.<br>
      In this case the validation logic is plain vanilla, because we only call
      the ISBN validator from the Apache Commons Validator project.<br>
      <em>@ISBN</em> is ready to be used. Just annotate your isbn property with
      it. You can see how:<br>
      <pre><code class="java">@Column(length=13) @ISBN
private String isbn;
</code></pre> Now, you can test your module, and verify that the ISBN values you
      enter are validated correctly. Congratulations, you have written your
      first <em>Bean Validation</em>. It's not so difficult. One annotation,
      one class.<br>
      This <em>@ISBN</em> is good enough for use in real life. Nevertheless,
      we'll try to improve it, simply to have the chance to experiment with a
      few interesting possibilities.<br>
      <h3 id="toc14"><a name="Lesson 6: Advanced validation-Creating your own Bean Validation annotation-Call to a REST web service to validate the ISBN"></a>Call
        to a REST web service to validate the ISBN</h3>
      Though most validators have simple logic, you can create validator with
      complex logic if necessary. For example, in the case of our ISBN, we want,
      not only to verify the correct format, but also to check that a book with
      that ISBN actually exists. A way to do this is by using web services.<br>
      As you already know, a web service is a functionality hosted in web
      servers and can be called by a program. The traditional way to develop and
      use web services is by means of <em>WS-*</em> standards, like <em>SOAP</em>,
      <em>UDDI</em>, etc., although, the simplest way to develop services today
      is <em>REST</em>. The basic idea of REST is to use the already existing
      “way to work” of the internet for inter-program communication. Calling a
      REST service consists of using a regular web URL to get a resource from a
      web server; this resource is usually data in <em>XML</em>, <em>HTML</em>,
      <em>JSON</em> or any other format. In other words, the programs use the
      internet just as regular users with their browsers.<br>
      There are a lot of sites with <em>SOAP</em> and <em>REST</em> web
      services that enable us to consult a book ISBN, but usually they are not
      free. So, we are going to use a cheaper alternative solution, that is, to
      call a normal web site to do an ISBN search, and to examine the resulting
      page to determine if the search has succeeded. Something like a
      pseudo-REST web service.<br>
      To call the web page we'll use the <a class="wiki_link_ext" href="http://htmlunit.sourceforge.net/"

        rel="nofollow">HtmlUnit</a> framework. Though the main goal of this
      framework is to create tests for your web applications, you can use it to
      read any web page. We'll use it because it's easier to use than other
      libraries used for the same purpose, as the <em>Apache Commons HttpClient</em>.
      See how easy it is to read a web page with <em>HtmlUnit</em>:<br>
      <pre><code class="java">WebClient client = new WebClient();
HtmlPage page = (HtmlPage) client.getPage("http://www.openxava.org/");
</code></pre> After that, you can use the <em>page</em> object to manipulate
      the read page.<br>
      OpenXava uses <em>HtmlUnit</em> as an underlaying framework for testing,
      so it is included with OpenXava. However, by default it's not included in
      OpenXava applications, so you have to include it yourself in your
      application. To do so, copy the files <em>cssparser.jar,
        htmlunit-core-js.jar, htmlunit.jar, httpclient.jar, httpcore.jar,
        httpmime.jar, nekothml.jar, sac.jar, xalan.jar, xercesImpl.jar,
        xml-apis.jar</em>, from the <em>OpenXava/lib</em> folder to <em>Invoicing/web/WEB-INF/lib</em>
      folder.<br>
      Let's modify <em>ISBNValidator</em> to use this <em>REST</em> service.
      See the result:<br>
      <pre><code class="java">package com.yourcompany.invoicing.validators;
 
import javax.validation.*;
 
import org.apache.commons.logging.*; // To use 'Log'
import com.yourcompany.invoicing.annotations.*;
import org.openxava.util.*;
 
import com.gargoylesoftware.htmlunit.*; // To use 'HtmlUnit'
import com.gargoylesoftware.htmlunit.html.*;
 
public class ISBNValidator implements ConstraintValidator&lt;ISBN, Object&gt; {
 
    private static Log log = LogFactory.getLog(ISBNValidator.class); // Instantiate 'log'
    private static org.apache.commons.validator.routines.ISBNValidator
        validator = new org.apache.commons.validator.routines.ISBNValidator();
 
    @Override
    public void initialize(ISBN isbn) {
 
    }
 
    @Override
    public boolean isValid(Object value,
        ConstraintValidatorContext context) {
        if (Is.empty(value)) return true;
        if (!validator.isValid(value.toString())) return false;
        return isbnExists(value); // Here we do the REST call
    }
 
    private boolean isbnExists(Object isbn) {
        String failMessage ="can't be found"; // Failed search message in 'bookfinder4u'
        try {
            WebClient client = new WebClient();
            HtmlPage page = (HtmlPage) client.getPage( // We call
                "http://www.bookfinder4u.com/" + // bookfinder4u
                "IsbnSearch.aspx?isbn=" + // using an URL for searching
                isbn + "&amp;mode=direct"); // by ISBN
            return page.asText() // Tests if the resulting page does not contain
                .indexOf(failMessage) &gt; 0; // the error message
        }
        catch (Exception ex) {
            log.warn("Impossible to connect to bookfinder4u" +
                "to validate the ISBN. Validation fails", ex);
            return false; // If there are errors we assume that validation fails
        }
    }
}
</code></pre> We simply open the URL with the ISBN as the request parameter. If
      the resulting page does not contain the <em>"can not be found"</em> error
      message the search has been successful. The <span class="wiki jcode">page.asText()</span>
      method returns the content of the HTML page without the HTML tags, that
      is, it only contains the text info.<br>
      You can use this trick with any site that allows you to do searches. Thus
      you can virtually consult millions of web site from inside your
      application. In a more pure REST web service the result will be a JSON or
      XML document instead of HTML, but usually you will have to pay some
      subscription fees.<br>
      Try out your application now and you'll see that validation will fail if
      you enter non-existent ISBN.<br>
      <h3 id="toc15"><a name="Lesson 6: Advanced validation-Creating your own Bean Validation annotation-Adding attributes to your annotation"></a>Adding
        attributes to your annotation</h3>
      It's a good idea to create a new <em>Bean Validation</em> annotation if
      you reuse the validation several times, usually across several projects.
      To improve the reusability you may want to parametrize the validation
      code. For example, for your current project to do the search in <a class="wiki_link_ext"

        href="http://www.bookfinder4u.com" rel="nofollow">www.bookfinder4u.com</a>
      for ISBN is OK, but in another project, or even in another entity of your
      current project, you do not want to call this particular URL. The code of
      the annotation has to be more flexible.<br>
      This flexibility can be achieved by attributes. For example, we can add a
      boolean search attribute to our ISBN annotation in order to switch on or
      off the internet search for validation. To implement this functionality,
      just add the <em>search</em> attribute to the ISBN annotation code:<br>
      <pre><code class="java">public @interface ISBN {
    boolean search() default true; // To (de)activate web search on validate
 
    // ...
}
</code></pre> This new search attribute can be read from the validator class:<br>
      <pre><code class="java">public class ISBNValidator implements ConstraintValidator&lt;ISBN, Object&gt; {
    // ...
    private boolean search; // Stores the search option
 
    @Override
    public void initialize(ISBN isbn) { // Read the annotation attributes values
        this.search = isbn.search();
    }
 
   @Override
    public boolean isValid(Object value, ConstraintValidatorContext context) {
        if (Is.empty(value)) return true;
        if (!validator.isValid(value.toString())) return false;
        return search ? isbnExists(value) : true; // Using 'search'
    }
    // ...
}
</code></pre> Here you see the use of the <span class="wiki jcode">initialize()</span>
      method: the source annotation can be used to initialize the validator, in
      this case simply by storing the <em>isbn.search()</em> value to evaluate
      it in <span class="wiki jcode">isValid()</span>.<br>
      Now you can choose whether you want to call our pseudo-REST service or
      skip the ISBN validation:<br>
      <pre><code class="java">@ISBN(search=false) // In this case no internet search is done to validate the ISBN
private String isbn;
</code></pre> Using this simple method you can add any attribute you need to add
      more flexibility to your ISBN annotation.<br>
      <br>
      Congratulations! You have learned how to create your own <em>Bean
        Validation</em> annotation, and by the way, to use the useful <em>HtmlUnit</em>
      tool.<br>
      <br>
      <h2 id="toc16"><a name="Lesson 6: Advanced validation-JUnit tests"></a>JUnit
        tests</h2>
      Our goal is not to develop a huge quantity of software, but to create
      quality software. At the end of the day, if you create quality software
      you will deliver more functionality, because you will spend more time on
      new and exciting things and less time on debugging legions of bugs. And
      you know that the only way to quality is automated testing, so lets update
      our test code.<br>
      <h3 id="toc17"><a name="Lesson 6: Advanced validation-JUnit tests-Testing validation for adding to a collection"></a>Testing
        validation for adding to a collection</h3>
      Recall that we have refined the code in a way that the user cannot assign
      orders to an invoice if the orders are not marked as delivered yet. After
      that, your current <em>testAddOrders()</em> of <em>InvoiceTest</em> can
      fail, because it tries to add the first order, and this first order might
      not be marked as delivered yet.<br>
      Let's modify the test method to run correctly and also to test your new
      validation functionality:<br>
      <pre><code class="java">public void testAddOrders() throws Exception {
    login("admin", "admin");
    assertListNotEmpty();
    execute("List.orderBy", "property=number");
    execute("List.viewDetail", "row=0");
    execute("Sections.change", "activeSection=1");
    assertCollectionRowCount("orders", 0);
    execute("Collection.add",
        "viewObject=xava_view_section1_orders");
    // execute("AddToCollection.add", "row=0"); // Now we don't select randomly
 
    checkFirstOrderWithDeliveredEquals("Delivered"); // Selects one delivered order
    checkFirstOrderWithDeliveredEquals(""); // Selects one not delivered order
    execute("AddToCollection.add"); // We try to add both
    assertError( // An error, because the not delivered order cannot be added
        "ERROR! 1 element(s) NOT added to Orders of Invoice");
    assertMessage( // A confirm message, because the delivered order has been added
        "1 element(s) added to Orders of Invoice");
 
    assertCollectionRowCount("orders", 1);
    checkRowCollection("orders", 0);
    execute("Collection.removeSelected",
        "viewObject=xava_view_section1_orders");
    assertCollectionRowCount("orders", 0);
}
</code></pre> We have modified the part for selecting orders to add. Before we
      selected the first order, no matter if it's delivered or not. Now we
      select one order delivered and one order not delivered. In this way we
      test if the delivered one is added and the not delivered one is rejected.<br>
      The missing piece here is the way to check the orders. This is the task of
      the <em>checkFirstOrderWithDeliveredEquals()</em> method:<br>
      <pre><code class="java">private void checkFirstOrderWithDeliveredEquals(String value) throws Exception {
    int c = getListRowCount(); // The total displayed rows in list
    for (int i=0; i&lt;c; i++) {
        if (value.equals(
            getValueInList(i, 13))) // 13 is the 'delivered' column
        {
            checkRow(i);
            return;
        }
    }
    fail("There must be at least one row with delivered=" + value);
}
</code></pre> Here you see a good technique to do a loop over the displayed list
      elements in order to check them, get data or do whatever you want with the
      list data.<br>
      <h3 id="toc18"><a name="Lesson 6: Advanced validation-JUnit tests-Testing validation assigning a reference and validation on removal"></a>Testing
        validation assigning a reference and validation on removal</h3>
      From the <em>Invoice</em> module the user cannot add orders to an invoice
      if they are not delivered yet, therefore, from the <em>Order</em> module
      the user cannot assign an invoice to an order if the order is not
      delivered. That is, we have to test the other side of the association too.
      We'll do it by modifying the existing <em>testSetInvoice()</em> of <em>OrderTest</em>.<br>
      Moreover, we'll use this case to test the remove validation we introduced
      in sections <a class="wiki_link" href="validation_en.html#toc7">Validating
        on removal with @RemoveValidator</a> and <a class="wiki_link" href="validation_en.html#toc8">Validating
        on removal with a JPA callback method</a>. There we modified the
      application to prevent the user from removing an order which has an
      invoice associated with it. Now we will test this restriction.<br>
      The revision of <em>testSetInvoice()</em> with all these enhancements is
      below:<br>
      <pre><code class="java">public void testSetInvoice() throws Exception {
    login("admin", "admin");
    assertListNotEmpty();
    execute("List.orderBy", "property=number"); // To set the list order
    execute("List.viewDetail", "row=0");
    assertValue("delivered", "false"); // The order must be not delivered
    execute("Sections.change", "activeSection=1");
    assertValue("invoice.number", "");
    assertValue("invoice.year", "");
    execute("Reference.search",
        "keyProperty=invoice.year");
    execute("List.orderBy", "property=number");
    String year = getValueInList(0, "year");
    String number = getValueInList(0, "number");
    execute("ReferenceSearch.choose", "row=0");
    assertValue("invoice.year", year);
    assertValue("invoice.number", number);
 
    // Not delivered order cannot have invoice
    execute("CRUD.save");
    assertErrorsCount(1); // We cannot save because it is not delivered
    setValue("delivered", "true");
    execute("CRUD.save"); // With delivered=true we can save the order
    assertNoErrors();
 
    // Order with invoice cannot be deleted
    execute("Mode.list"); // We go to list and
    execute("CRUD.deleteRow", "row=0"); // we delete the saved order
    assertError("Impossible to remove Order because: " + // We cannot delete because
        "An order with an invoice cannot be deleted"); // it has an invoice associated
 
    // Restoring original values
    execute("List.viewDetail", "row=0");
    setValue("delivered", "false");
    setValue("invoice.year", "");
    execute("CRUD.save");
    assertNoErrors();
}
</code></pre> The original test only searched for an invoice, but did not even
      save it. Now, we added test code at the end which tries to save the order
      with delivered=false and with delivered=true, in this way we test the
      validation. After that, we try to delete the order, that has an invoice.
      Thus we test the validation on removal too.<br>
      <h3 id="toc19"><a name="Lesson 6: Advanced validation-JUnit tests-Testing the custom Bean Validation"></a>Testing
        the custom <em>Bean Validation</em></h3>
      The last step is to test the <em>ISBN Bean Validation</em>, which uses a
      REST service to do validation. We simply have to write a test case that
      tries to assign an incorrect, a nonexistent and a correct ISBN to a
      product and checks the results for these cases. To do so let's add a <em>testISBNValidator()</em>
      method to <em>ProductTest</em>.<br>
<pre><code class="java">public void testISBNValidator() throws Exception {
    login("admin", "admin");
 
    // Searching the product1
    execute("CRUD.new");
    setValue("number", Integer.toString(product1.getNumber()));
    execute("CRUD.refresh");
    assertValue("description", "JUNIT Product 1");
    assertValue("isbn", "");
 
    // With incorrect ISBN format
    setValue("isbn", "1111");
    execute("CRUD.save"); // Fails because of format (apache commons validator)
    assertError("1111 is not a valid value for ISBN of " +
        "Product: ISBN does not exist");
 
    // ISBN does not exist though it has correct format
    setValue("isbn", "9791034369997");
    execute("CRUD.save"); // Fails because it does not exist (REST service)
    assertError("9791034369997 is not a valid value for ISBN of " +
        "Product: ISBN does not exist");
 
    // ISBN exists
    setValue("isbn", "9780932633439");
    execute("CRUD.save"); // It does not fail
    assertNoErrors();
}
</code></pre>
      Surely the manual testing you were doing during the development of the <em>@ISBN</em>
      validator was like the one above. Therefore, if <a class="wiki_link_ext"

        href="http://www.extremeprogramming.org/rules/testfirst.html" rel="nofollow">you
        write your JUnit test before the application code</a>, you can use it as
      you proceed. This is more efficient than repeating the test procedures by
      hand using the browser over and over again.<br>
      Note that if you use <span class="wiki jcode">@ISBN(search=false)</span>
      this test will not work because it checks the result of the REST service.
      So, you have to use the <em>@ISBN</em> annotation of the isbn property
      without the search attribute in order to run this test successfully.<br>
      Now execute all the tests for your Invoicing application to verify that
      everything works as expected.<br>
      <br>
      <h2 id="toc20"><a name="Lesson 6: Advanced validation-Summary"></a>Summary</h2>
      In this lesson you have learned several ways to do validation in an
      OpenXava application. Also, you know how to encapsulate the reusable
      validation logic in annotations with custom Bean Validation.<br>
      Validation is an important part of the logic of your application, and we
      encourage you to put it into the model, i. e. into your entities. We
      demonstrated several examples for this technique in the lesson. Sometimes
      it is more convenient to put logic outside your model classes. You will
      learn that in the next lessons.<br>
      <br>
      <strong><a class="wiki_link_ext" href="https://sourceforge.net/projects/openxava/files/openxava-course-source-code/openxava-course-source-code-lesson-6-validation_en.zip/download"

          rel="nofollow">Download source code of this lesson</a></strong><br>
      <br>
      <strong>Any problem with this lesson? <a class="wiki_link_ext" href="http://sourceforge.net/p/openxava/discussion/419690/"

          rel="nofollow">Ask in the forum</a></strong> <strong>Everything fine?
        <a class="wiki_link" href="refining-standard-behavior_en.html">Go to
          Lesson 7</a></strong> </div>
  </body>
</html>
